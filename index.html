<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼˜åˆ†æ˜Ÿæ²³ (GalaxyMatch)</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base font and background */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        /* Custom shadow for cards */
        .card-shadow { box-shadow: 0 10px 30px rgba(45, 55, 72, 0.1); }
        /* Styling for the profile card with fallback image */
        .match-card {
            min-height: 500px;
            background-image: url('https://placehold.co/400x500/A0BFFF/ffffff?text=Profile+Photo'); 
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col">
    <!-- Application content is rendered here -->
</div>

<script type="module">
    // --- Firebase Imports (Mandatory for persistence) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- Global Variables and Firebase Init Setup ---

    // NOTE FOR GITHUB DEPLOYMENT: 
    const USER_FIREBASE_CONFIG = {
        apiKey: "AIzaSyD5VkzYpa0VnbelrC5tr2jSdzeI7cu8N0A", // 
        authDomain: "my-project-93cf8.firebaseapp.com", // 
        projectId: "my-project-93cf8", // 
        storageBucket: "my-project-93cf8.firebasestorage.app",
        messagingSenderId: "895298236924",
        appId: "1:895298236924:web:9293fc8b56316fd7c24279"
        // measurementId: "G-SK2C8VKJEY" // measurementId å¯é€‰ï¼Œç”¨äº GitHub éƒ¨ç½²æ—¶å¯ä»¥çœç•¥ã€‚
    };

    // å†³å®šä½¿ç”¨çš„ Firebase é…ç½®ï¼šä¼˜å…ˆä½¿ç”¨ Canvas æ³¨å…¥çš„é…ç½®ï¼Œå¦åˆ™ä½¿ç”¨ç”¨æˆ·é…ç½®
    const firebaseConfig = typeof __firebase_config !== 'undefined' 
        ? JSON.parse(__firebase_config) 
        : USER_FIREBASE_CONFIG;
        
    // App ID å†³å®š Firestore è·¯å¾„
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, db, auth, userId = null;
    let profilesCollectionRef = null;
    
    // Global State Management
    let state = {
        isAuthReady: false,
        currentPage: 'loading', 
        currentUser: null,
        allProfiles: [], // Profiles available for swiping/matching
        matchedProfiles: [], // Profiles that liked current user (for 'Who Likes You' feature)
        currentViewingIndex: 0,
    };

    // Firebase Initialization Function
    async function initializeFirebase() {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦éœ€è¦æ›´æ–°é…ç½®ä»¥è¿›è¡Œå…¬å…±éƒ¨ç½² (è¿™é‡Œæ£€æŸ¥ projectId æ˜¯å¦å·²æ›¿æ¢)
        if (firebaseConfig.projectId === "YOUR_PROJECT_ID") {
            console.error("Firebase config is missing or using placeholder keys.");
            document.getElementById('app').innerHTML = `<div class="flex-grow flex items-center justify-center p-4">
                <div class="w-full max-w-md p-8 bg-white rounded-xl card-shadow text-center text-red-600">
                    <h2 class="text-2xl font-bold mb-4">ğŸš¨ Firebase é…ç½®ç¼ºå¤± ğŸš¨</h2>
                    <p class="text-gray-700">è¯·åœ¨ index.html æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨æ‚¨è‡ªå·±çš„ Firebase é¡¹ç›®é…ç½®æ›¿æ¢ <code>USER_FIREBASE_CONFIG</code> å˜é‡ä¸­çš„å ä½ç¬¦ã€‚</p>
                </div>
            </div>`;
            return;
        }
        
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        try {
            // Sign in using custom token (Canvas) or anonymously (public deployment fallback)
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth); // å…¬å¼€éƒ¨ç½²æ—¶ä½¿ç”¨åŒ¿åç™»å½•
            }
        } catch (error) {
            console.error("Firebase Authentication Error:", error);
            document.getElementById('app').innerHTML = `<div class="p-8 text-center text-red-600">èº«ä»½éªŒè¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚</div>`;
            return;
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                // Private data storage path 
                profilesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/galaxymatch_profiles`);
                console.log("Authenticated with UID:", userId);
                state.isAuthReady = true;
                
                listenToCurrentUserProfile();
                listenToAllProfiles();
            } else {
                state.isAuthReady = true;
                state.currentPage = 'login';
                renderApp();
            }
        });
    }

    // --- Firestore Listeners ---

    // Listen for changes to the current user's profile document
    function listenToCurrentUserProfile() {
        if (!userId) return;

        const userDocRef = doc(profilesCollectionRef, userId);
        onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                state.currentUser = { id: userId, ...docSnap.data() };
                // Handle initial page routing based on profile completion
                if (state.currentUser.profileComplete && state.currentPage === 'login') {
                    state.currentPage = 'match';
                } else if (!state.currentUser.profileComplete) {
                    state.currentPage = 'profile';
                }
            } else {
                state.currentUser = null;
                state.currentPage = 'login';
            }
            renderApp();
        }, (error) => {
            console.error("Error listening to user profile:", error);
        });
    }

    // Listen to all profiles in the collection (to find matches)
    function listenToAllProfiles() {
        if (!profilesCollectionRef) return;
        
        onSnapshot(profilesCollectionRef, (snapshot) => {
            const all = [];
            const likedByMe = state.currentUser?.likes || [];
            const matches = state.currentUser?.matches || [];
            const currentLikes = []; // Used for the "Who Likes You" page

            snapshot.forEach(doc => {
                if (doc.id !== userId) {
                    const profile = { id: doc.id, ...doc.data() };
                    
                    // Profiles that have liked me (potential matches for 'likes' page)
                    if (profile.likes && profile.likes.includes(userId) && !matches.includes(profile.id)) {
                        currentLikes.push(profile);
                    }

                    // Filter out profiles I've already interacted with (liked or matched) for the main match deck
                    if (!likedByMe.includes(profile.id) && !matches.includes(profile.id)) {
                        all.push(profile);
                    }
                }
            });

            // Sort by Match Score (higher score = better match recommendation)
            state.allProfiles = all.sort((a, b) => getMatchScore(b) - getMatchScore(a));
            state.matchedProfiles = currentLikes;
            state.currentViewingIndex = 0; // Reset index to show the top new profile
            renderApp();
        }, (error) => {
            console.error("Error listening to all profiles:", error);
        });
    }

    // --- Match Algorithm (Simplified W3 - Worldview/Three Views) ---

    // Calculates score based on the number of identical answers in the Q&A section
    function getMatchScore(targetProfile) {
        if (!state.currentUser || !state.currentUser.qna || !targetProfile.qna) return 0;

        let score = 0;
        const userQna = state.currentUser.qna;
        const targetQna = targetProfile.qna;
        // Check for matching answers across the 6 questions
        for (const key in userQna) {
            if (userQna[key] === targetQna[key]) {
                score++;
            }
        }
        return score; 
    }


    // --- Core Actions ---

    async function handleLike(targetId) {
        if (!state.currentUser || !targetId) return;

        const userDocRef = doc(profilesCollectionRef, userId);
        const targetDocRef = doc(profilesCollectionRef, targetId);

        // 1. Update my 'likes' list
        await updateDoc(userDocRef, {
            likes: arrayUnion(targetId)
        });

        // 2. Check for Match (did they already like me?)
        const targetSnap = await getDoc(targetDocRef);
        const targetLikes = targetSnap.data()?.likes || [];

        if (targetLikes.includes(userId)) {
            // It's a MATCH! Remove from likes and add to matches for both users.
            await updateDoc(userDocRef, {
                matches: arrayUnion(targetId),
                likes: arrayRemove(targetId) 
            });
            await updateDoc(targetDocRef, {
                matches: arrayUnion(userId),
                likes: arrayRemove(userId) 
            });
            console.log(`ğŸ‰ MATCH: You matched with ${targetSnap.data().nickname}!`);
            // Optional: Display a match modal here instead of just logging
        } 
        
        // Move to next profile
        state.currentViewingIndex = 0; 
        renderApp();
    }

    async function handleSkip() {
        // Move to the next profile locally
        state.currentViewingIndex++;
        renderApp();
    }

    async function saveProfile() {
        const form = document.getElementById('profile-form');
        // Basic Profile Info
        const nickname = form.nickname.value;
        const age = parseInt(form.age.value);
        const gender = form.gender.value;
        const lookingFor = form.lookingFor.value;
        
        // W3 Q&A Info
        const qna = {};
        const qnaQuestions = ['q1_money', 'q2_children', 'q3_work', 'q4_social', 'q5_conflict', 'q6_pace'];
        let allQnaAnswered = true;
        
        qnaQuestions.forEach(id => {
            const answer = form.elements[id].value;
            if (!answer) allQnaAnswered = false;
            qna[id] = answer;
        });

        if (!allQnaAnswered) {
            console.error('è¯·å›ç­”æ‰€æœ‰ä¸‰è§‚é—®ç­”é¢˜ä»¥å®Œæˆæ¡£æ¡ˆ!');
            // In a real app, display a custom modal message to the user here.
            return;
        }

        const profileData = {
            nickname,
            age,
            gender,
            lookingFor,
            qna,
            profileComplete: true,
            // Simple text placeholder for the profile photo
            photoUrl: `https://placehold.co/400x500/A0BFFF/ffffff?text=${nickname.substring(0, 1)}`, 
            likes: state.currentUser?.likes || [],
            matches: state.currentUser?.matches || [],
            isVIP: state.currentUser?.isVIP || false, // Mock VIP status
        };

        try {
            const userDocRef = doc(profilesCollectionRef, userId);
            // Use setDoc to create or overwrite the user's profile document
            await setDoc(userDocRef, profileData);
            console.log('Profile saved successfully!');
            // The listener (onSnapshot) will automatically handle the page transition
        } catch (error) {
            console.error("Error saving profile:", error);
        }
    }
    
    // --- Event Handlers and Listeners ---
    
    function handleProfileSubmit(e) {
        e.preventDefault();
        saveProfile();
    }

    function attachListeners() {
        // Attach listener only when the profile page is active
        if (state.currentPage === 'profile') {
            const form = document.getElementById('profile-form');
            if (form) {
                form.removeEventListener('submit', handleProfileSubmit); 
                form.addEventListener('submit', handleProfileSubmit);
            }
        }
    }

    // --- Router and View Renderer ---

    function renderApp() {
        const appContainer = document.getElementById('app');
        let content = '';
        
        // Ensure user completes profile before accessing main features
        const currentPage = state.currentUser?.profileComplete ? state.currentPage : 'profile';

        switch (currentPage) {
            case 'loading':
                content = renderLoading();
                break;
            case 'login':
                content = renderLogin();
                break;
            case 'profile':
                content = renderProfile();
                break;
            case 'match':
                content = renderMatchDashboard();
                break;
            case 'chat':
                content = renderChatList();
                break;
            case 'likes':
                content = renderWhoLikesYou();
                break;
            default:
                content = renderLoading();
        }

        // Render Navbar and the current page content
        appContainer.innerHTML = renderNavbar() + content;
        attachListeners(); 
    }

    // --- View Rendering Functions ---

    function renderLoading() {
        return `
            <div class="flex-grow flex items-center justify-center p-8">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500 mx-auto"></div>
                    <p class="mt-4 text-gray-600">æ˜Ÿæ²³æ­£åœ¨åŠ è½½...</p>
                </div>
            </div>
        `;
    }

    function renderNavbar() {
        if (!state.isAuthReady || state.currentPage === 'loading') return '';

        const navItems = [
            { id: 'match', label: 'âœ¨ æ ¸å¿ƒæ¨è', icon: 'M13 10V3L4 14h7v7l9-11h-7z' },
            { id: 'likes', label: 'ğŸ’Œ è°å–œæ¬¢æˆ‘', icon: 'M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z' },
            { id: 'chat', label: 'ğŸ’¬ æ¶ˆæ¯ä¸­å¿ƒ', icon: 'M7 8h10M7 12h4m-4 8l4-4h4a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v10a2 2 0 002 2h2a2 2 0 012 2z' },
            { id: 'profile', label: 'ğŸ‘¤ æˆ‘çš„æ¡£æ¡ˆ', icon: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' },
        ];

        return `
            <nav class="bg-white card-shadow sticky top-0 z-10">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <div class="flex-shrink-0 text-xl font-bold text-indigo-600">
                            ç¼˜åˆ†æ˜Ÿæ²³
                        </div>
                        <div class="flex space-x-2 md:space-x-4">
                            ${navItems.map(item => `
                                <button onclick="window.setPage('${item.id}')"
                                    class="py-2 px-3 rounded-xl transition duration-150 ease-in-out 
                                    ${state.currentPage === item.id ? 'bg-indigo-500 text-white shadow-lg' : 'text-gray-600 hover:bg-gray-100'}">
                                    <svg class="w-6 h-6 inline-block md:mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon}"></path></svg>
                                    <span class="hidden md:inline">${item.label}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </nav>
        `;
    }

    function renderLogin() {
        return `
            <div class="flex-grow flex items-center justify-center p-4">
                <div class="w-full max-w-md p-8 bg-white rounded-xl card-shadow text-center">
                    <h2 class="text-3xl font-bold text-indigo-600 mb-6">æ¬¢è¿æ¥åˆ° ç¼˜åˆ†æ˜Ÿæ²³</h2>
                    <p class="text-gray-600 mb-8">å¼€å§‹ä¸€æ®µè®¤çœŸã€é«˜è´¨é‡çš„å…³ç³»ã€‚è¯·å…ˆåˆ›å»ºæ‚¨çš„ä¸ªäººæ¡£æ¡ˆã€‚</p>
                    <button onclick="window.setPage('profile')"
                        class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-150">
                        å¼€å§‹åˆ›å»ºæ¡£æ¡ˆ
                    </button>
                    <p class="mt-4 text-sm text-gray-500">ç”¨æˆ·ID: ${userId || 'N/A'}</p>
                </div>
            </div>
        `;
    }

    function renderProfile() {
        const user = state.currentUser || {};
        const isComplete = user.profileComplete;

        // Structured Q&A for W3 matching
        const qnaQuestions = [
            { id: 'q1_money', text: 'Q1: ä½ è®¤ä¸ºå®¶åº­å¼€æ”¯æ˜¯å¦éœ€è¦å®Œå…¨é€æ˜ï¼Ÿ', options: ['æ˜¯ï¼Œå¿…é¡»é€æ˜', 'å¦ï¼Œä¿ç•™ä¸ªäººç©ºé—´', 'å¼¹æ€§åå•†'] },
            { id: 'q2_children', text: 'Q2: ä½ ç†æƒ³çš„å­å¥³æ•°é‡æ˜¯ï¼Ÿ', options: ['æ— ', 'ä¸€ä¸ª', 'ä¸¤ä¸ª', 'éšç¼˜'] },
            { id: 'q3_work', text: 'Q3: å·¥ä½œä¸ç”Ÿæ´»çš„å¹³è¡¡ï¼Œä½ æ›´å€¾å‘äºï¼Ÿ', options: ['å·¥ä½œä¼˜å…ˆ', 'ç”Ÿæ´»ä¼˜å…ˆ', 'ä¸¥æ ¼å¹³è¡¡'] },
            { id: 'q4_social', text: 'Q4: ä½ å¯¹ä¼´ä¾£çš„å¼‚æ€§ç¤¾äº¤é¢‘ç‡æ€åº¦æ˜¯ï¼Ÿ', options: ['æ— é™åˆ¶ï¼Œä¿¡ä»»', 'éœ€æŠ¥å¤‡', 'æœ‰é™åˆ¶', 'å®Œå…¨ä¸èƒ½æ¥å—'] },
            { id: 'q5_conflict', text: 'Q5: é¢å¯¹é‡å¤§çŸ›ç›¾ï¼Œä½ çš„é¦–è¦å¤„ç†æ–¹å¼æ˜¯ï¼Ÿ', options: ['å†·é™ç‹¬å¤„ï¼Œäº‹åæ²Ÿé€š', 'ç«‹å³æ²Ÿé€šï¼Œç›´åˆ°è§£å†³', 'å¯»æ±‚ç¬¬ä¸‰æ–¹æ„è§'] },
            { id: 'q6_pace', text: 'Q6: ä½ æ›´äº«å—å“ªç§ç”Ÿæ´»çŠ¶æ€ï¼Ÿ', options: ['æ˜ç¡®ç›®æ ‡ï¼Œå…¨åŠ›æ‹¼æ', 'æ…¢èŠ‚å¥ï¼Œäº«å—å½“ä¸‹', 'çµæ´»å¤šå˜'] },
        ];

        return `
            <div class="flex-grow max-w-3xl mx-auto p-4 md:p-8">
                <div class="bg-white p-6 md:p-10 rounded-xl card-shadow">
                    <h2 class="text-2xl font-bold text-indigo-600 mb-4">${isComplete ? 'ç¼–è¾‘' : 'åˆ›å»º'}ä¸ªäººæ¡£æ¡ˆ</h2>
                    <p class="text-sm text-gray-500 mb-6">è¯·å¡«å†™æ¡£æ¡ˆå¹¶å®Œæˆä¸‰è§‚é—®ç­”ï¼Œæ‰èƒ½è¢«æ¨èç»™å…¶ä»–ç”¨æˆ·ã€‚</p>
                    
                    <form id="profile-form">
                        <!-- Basic Info Section -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                            <div>
                                <label class="block text-gray-700 font-medium mb-1">æ˜µç§°</label>
                                <input id="nickname" name="nickname" type="text" value="${state.currentUser?.nickname || ''}" required 
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-1">å¹´é¾„</label>
                                <input id="age" name="age" type="number" value="${state.currentUser?.age || ''}" required min="18" max="99"
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-1">æ€§åˆ«</label>
                                <select id="gender" name="gender" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="" disabled ${!state.currentUser?.gender ? 'selected' : ''}>è¯·é€‰æ‹©</option>
                                    <option value="male" ${state.currentUser?.gender === 'male' ? 'selected' : ''}>ç”·</option>
                                    <option value="female" ${state.currentUser?.gender === 'female' ? 'selected' : ''}>å¥³</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-1">æ­£åœ¨å¯»æ‰¾</label>
                                <select id="lookingFor" name="lookingFor" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="" disabled ${!state.currentUser?.lookingFor ? 'selected' : ''}>è¯·é€‰æ‹©</option>
                                    <option value="male" ${state.currentUser?.lookingFor === 'male' ? 'selected' : ''}>ç”·æ€§</option>
                                    <option value="female" ${state.currentUser?.lookingFor === 'female' ? 'selected' : ''}>å¥³æ€§</option>
                                    <option value="both" ${state.currentUser?.lookingFor === 'both' ? 'selected' : ''}>ä¸é™</option>
                                </select>
                            </div>
                        </div>

                        <!-- Three Views (W3) Q&A Section -->
                        <h3 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">ä¸‰è§‚é—®ç­” (W3 æ ¸å¿ƒ)</h3>
                        ${qnaQuestions.map(q => `
                            <div class="mb-5 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                <label class="block text-gray-700 font-semibold mb-2">${q.text}</label>
                                <div class="space-y-2">
                                    ${q.options.map(opt => `
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="${q.id}" value="${opt}" required 
                                                class="form-radio h-4 w-4 text-indigo-600" 
                                                ${state.currentUser?.qna && state.currentUser.qna[q.id] === opt ? 'checked' : ''}>
                                            <span class="ml-2 text-gray-600">${opt}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                        
                        <button type="submit"
                            class="w-full py-3 mt-4 bg-green-500 text-white font-semibold rounded-xl hover:bg-green-600 transition duration-150">
                            ${isComplete ? 'ä¿å­˜æ¡£æ¡ˆå¹¶è¿›å…¥æ˜Ÿæ²³' : 'å®Œæˆæ¡£æ¡ˆå¹¶è¿›å…¥æ˜Ÿæ²³'}
                        </button>
                        ${isComplete ? `<p class="mt-4 text-sm text-green-600 font-bold text-center">æ¡£æ¡ˆå·²å®Œæˆï¼</p>` : ''}
                    </form>
                </div>
            </div>
        `;
    }

    function renderMatchDashboard() {
        const currentProfile = state.allProfiles[state.currentViewingIndex];

        if (!currentProfile) {
            return `
                <div class="flex-grow flex items-center justify-center p-8">
                    <div class="text-center w-full max-w-md bg-white p-8 rounded-xl card-shadow">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">ä»Šæ—¥æ¨èå·²æµè§ˆå®Œæ¯•</h3>
                        <p class="text-gray-600">è¯·è€å¿ƒç­‰å¾…æ–°çš„ç¼˜åˆ†å‡ºç°ï¼Œæˆ–å‡çº§ VIP æŸ¥çœ‹æ›´å¤šæœºä¼šã€‚</p>
                    </div>
                </div>
            `;
        }

        const matchScore = getMatchScore(currentProfile);
        const matchPercentage = Math.round((matchScore / 6) * 100);
        
        return `
            <div class="flex-grow flex items-center justify-center p-4">
                <div class="w-full max-w-lg">
                    <div class="match-card rounded-xl card-shadow relative overflow-hidden" 
                        style="background-image: url('${currentProfile.photoUrl}')">
                        
                        <!-- Core Info Overlay -->
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-transparent p-6 flex flex-col justify-end">
                            <h2 class="text-3xl font-bold text-white">${currentProfile.nickname}, ${currentProfile.age}</h2>
                            <p class="text-white/80 mb-4">${currentProfile.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'} | ${matchScore} é¡¹ä¸‰è§‚ç›¸ä¼¼</p>
                            
                            <!-- Match Badge -->
                            <div class="bg-indigo-500 text-white font-bold px-3 py-1 rounded-full w-fit mb-4 text-sm shadow-md">
                                ç¼˜åˆ†æŒ‡æ•°: ${matchPercentage}%
                            </div>
                            
                            <!-- Interaction Buttons -->
                            <div class="flex justify-between space-x-4">
                                <button onclick="window.handleSkipAndNext()"
                                    class="flex-1 py-3 bg-red-500 text-white font-semibold rounded-full hover:bg-red-600 transition duration-150 transform hover:scale-105">
                                    âŒ è·³è¿‡
                                </button>
                                <button onclick="window.handleLikeAndNext('${currentProfile.id}')"
                                    class="flex-1 py-3 bg-green-500 text-white font-semibold rounded-full hover:bg-green-600 transition duration-150 transform hover:scale-105">
                                    â¤ï¸ å–œæ¬¢
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Helper function to handle 'Like' action and move to next profile
    window.handleLikeAndNext = async (targetId) => {
        await handleLike(targetId);
        // The listener will update the profile list, and renderApp forces UI update.
    };
    
    // Helper function to handle 'Skip' action and move to next profile
    window.handleSkipAndNext = async () => {
        await handleSkip();
    };

    function renderChatList() {
        const matches = state.currentUser?.matches || [];
        
        if (matches.length === 0) {
            return `
                <div class="flex-grow flex items-center justify-center p-8">
                    <div class="text-center w-full max-w-md bg-white p-8 rounded-xl card-shadow">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">æ¶ˆæ¯ä¸­å¿ƒ</h3>
                        <p class="text-gray-600">æ‚¨è¿˜æ²¡æœ‰é…å¯¹æˆåŠŸçš„å¯¹è±¡ï¼Œå»â€œæ ¸å¿ƒæ¨èâ€å¼€å§‹ä¸€æ®µç¼˜åˆ†å§ï¼</p>
                    </div>
                </div>
            `;
        }

        return `
            <div class="flex-grow max-w-4xl mx-auto p-4 md:p-8">
                <h2 class="text-2xl font-bold text-indigo-600 mb-6">ğŸ’¬ é…å¯¹åˆ—è¡¨ (${matches.length} ä¸ª Match)</h2>
                <div class="space-y-4">
                    ${matches.map(matchId => {
                        // Find profile details from combined list for display
                        const profile = state.allProfiles.find(p => p.id === matchId) || 
                            state.matchedProfiles.find(p => p.id === matchId) ||
                            {nickname: 'æœªçŸ¥ç”¨æˆ·', photoUrl: 'https://placehold.co/60x60/cccccc/ffffff?text=?'};
                        return `
                            <div class="flex items-center p-4 bg-white rounded-xl card-shadow hover:bg-gray-50 transition duration-150">
                                <img src="${profile.photoUrl}" onerror="this.onerror=null; this.src='https://placehold.co/60x60/cccccc/ffffff?text=?'" class="w-16 h-16 object-cover rounded-full mr-4">
                                <div class="flex-grow">
                                    <p class="text-lg font-semibold text-gray-800">${profile.nickname}</p>
                                    <p class="text-sm text-green-500 font-medium">âœ¨ å·²é…å¯¹æˆåŠŸ</p>
                                </div>
                                <button onclick="console.log('Entering chat with ${profile.nickname}')" class="bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-600">
                                    å¼€å§‹èŠå¤©
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }

    function renderWhoLikesYou() {
        const likes = state.matchedProfiles;
        const isVIP = state.currentUser?.isVIP; // VIP status is currently mocked as false

        if (!isVIP) {
            return `
                <div class="flex-grow flex items-center justify-center p-8">
                    <div class="text-center w-full max-w-md bg-white p-8 rounded-xl card-shadow">
                        <h3 class="text-2xl font-bold text-indigo-600 mb-4">ğŸ”“ è°å–œæ¬¢æˆ‘ (VIP Star ä¸“å±)</h3>
                        <p class="text-gray-600 mb-6">æœ‰ **${likes.length}** ä½ç”¨æˆ·å¯¹æ‚¨è¡¨ç¤ºäº†å…´è¶£ï¼</p>
                        <!-- Blurred placeholders for profiles -->
                        <div class="flex justify-center -space-x-4 mb-8">
                            ${likes.slice(0, 5).map(() => `
                                <img src="https://placehold.co/60x60/312e81/ffffff?text=?" class="w-12 h-12 object-cover rounded-full border-4 border-white filter blur-md">
                            `).join('')}
                        </div>
                        <button onclick="console.log('Upgrade to VIP Star to unlock likes!')"
                            class="w-full py-3 bg-yellow-500 text-white font-semibold rounded-xl hover:bg-yellow-600 transition duration-150">
                            å‡çº§ VIP Star è§£é” (ï¿¥99/æœˆ)
                        </button>
                    </div>
                </div>
            `;
        }
        
        // VIP View (Unlocks if isVIP is true)
        return `
            <div class="flex-grow max-w-4xl mx-auto p-4 md:p-8">
                <h2 class="text-2xl font-bold text-indigo-600 mb-6">ğŸ’Œ å–œæ¬¢æ‚¨çš„ç”¨æˆ· (${likes.length} ä½)</h2>
                <p class="text-sm text-gray-500 mb-4">ä½œä¸º VIP Star ä¼šå‘˜ï¼Œæ‚¨å¯ä»¥ç›´æ¥æŸ¥çœ‹å¹¶å†³å®šæ˜¯å¦å–œæ¬¢ä»–ä»¬ã€‚</p>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                    ${likes.map(profile => `
                        <div class="bg-white p-4 rounded-xl card-shadow text-center">
                            <img src="${profile.photoUrl}" onerror="this.onerror=null; this.src='https://placehold.co/150x180/A0BFFF/ffffff?text=${profile.nickname.substring(0, 1)}'" class="w-full h-40 object-cover rounded-lg mb-3">
                            <p class="font-semibold text-gray-800">${profile.nickname}, ${profile.age}</p>
                            <button onclick="window.handleLikeAndNext('${profile.id}')"
                                class="w-full mt-2 py-2 bg-pink-500 text-white rounded-lg text-sm hover:bg-pink-600">
                                â¤ï¸ å–œæ¬¢ TA
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // --- Global Functions (exposed to HTML for click events) ---
    window.setPage = (pageId) => {
        state.currentPage = pageId;
        renderApp();
    };

    // --- Initial Call ---
    window.onload = initializeFirebase;
</script>
</body>
</html>

